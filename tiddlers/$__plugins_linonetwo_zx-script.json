[
    {
        "title": "$:/plugins/linonetwo/zx-script",
        "name": "ZX Script Executor",
        "description": "ZX is a tool for writing better scripts, this plugin allows you to execute a tiddler with zx.",
        "author": "LinOnetwo",
        "core-version": ">=5.1.22",
        "plugin-type": "plugin",
        "version": "0.2.2",
        "dependents": "$:/plugins/linonetwo/itonnote",
        "list": "readme demo developer",
        "type": "application/json",
        "text": "{\"tiddlers\":{\"$:/plugins/linonetwo/zx-script/OutputBar\":{\"title\":\"$:/plugins/linonetwo/zx-script/OutputBar\",\"creator\":\"LinOnetwo\",\"tags\":\"$:/tags/ViewTemplate\",\"type\":\"text/vnd.tiddlywiki\",\"list-before\":\"$:/plugins/linonetwo/inverse-link-and-folder/infobar\",\"text\":\"<$list filter=\\\"[{!!title}addprefix[$:/state/linonetwo/zx-script/output/]is[tiddler]then{!!title}]\\\">\\n  <$list filter=\\\"[{!!title}addprefix[$:/state/linonetwo/zx-script/output/]]\\\">\\n    <!-- Space between top level and inner level transclude can't be omit, otherwise generated line will stick together, and destroy the tw render -->\\n    <$transclude>\\n\\n      <$transclude tiddler=\\\"$:/language/MissingTiddler/Hint\\\"/>\\n\\n    </$transclude>\\n\\n    <small><$link to=<<currentTiddler>> /></small>\\n  </$list>\\n</$list>\\n\"},\"$:/plugins/linonetwo/zx-script/ViewToolbarButton\":{\"title\":\"$:/plugins/linonetwo/zx-script/ViewToolbarButton\",\"tags\":\"$:/tags/ViewToolbar\",\"type\":\"text/vnd.tiddlywiki\",\"list-before\":\"$:/core/ui/Buttons/close\",\"caption\":\"{{$:/plugins/linonetwo/zx-script/zx-icon}} {{$:/plugins/linonetwo/zx-script/zx-button-caption}}\",\"short-caption\":\"zx script executor\",\"description\":\"Run tiddler as ZX Script\",\"text\":\"\\\\whitespace trim\\n<$list filter=\\\"[all[current]!has[plugin-type]]\\\">\\n<$list filter=\\\"[all[current]field:type[application/javascript]] :else[all[current]search:text[```]]\\\">\\n  <$execute-zx-script content={{!!text}} title={{!!title}} type={{!!type}} />\\n</$list>\\n</$list>\"},\"$:/plugins/linonetwo/zx-script/demo\":{\"title\":\"$:/plugins/linonetwo/zx-script/demo\",\"type\":\"text/vnd.tiddlywiki\",\"text\":\"!! ZX JS script Demo\\n\\n```js\\nconsole.log(`!! Hi!`);\\n```\\n\\nResult will form a tiddler.\\n\\n```js\\nconsole.log(`\\nCode block:\\n\\n\\\\`\\\\`\\\\`js\\nconsole.log(\\\\`!! Hi!\\\\`);\\n\\\\`\\\\`\\\\`\\n`);\\n```\\n\\n!! Dynamic WikiText Demo\\n\\n```js\\nconst ramdomID = Math.random().toString(36).slice(2);\\nconst text = `<fieldset>\\n\\t<legend>Quick Add</legend>\\n\\n\\t<$button>\\n\\t\\t<$action-sendmessage $message=\\\"tm-new-tiddler\\\" title=<<now \\\"YYYY-MM-DD\\\">> tags=\\\"${ramdomID}\\\" />\\n    Add New Tiddler with ID ${ramdomID}\\n\\t</$button>\\n\\n</fieldset>`\\n\\nconsole.log(text)\\n```\\n\\n!! Wiki Scripting Demo\\n\\n```js\\nconst exampleTitle = '$:/plugins/linonetwo/zx-script/style.css';\\n\\n// to write script execute in tiddlywiki context, start with this separator ↓\\n/** tw */\\n// You can use $tw.wiki.getTiddler to get tiddler data, and can use some variables from previous context\\nconst tiddlerData = $tw.wiki.getTiddler(exampleTitle);\\n// This script runs in the nodejs side, and you can't access some API from nodejs ↓ it will cause error\\n// $tw.notifier.display('$:/state/notification/asdf');\\n\\n// You can even add tiddler using the API! But this will be add to the nodejs side, it will take a while to wait it sync to the browser side.\\n// $tw.syncadaptor.wiki.addTiddler({ title: 'asdf', text: 'aaa bbb' });\\n// You can't add state tiddler this way, they won't get sync to the browser. (nodejs wiki limitation)\\n// $tw.syncadaptor.wiki.addTiddler({ title: '$:/state/notification/asdf', text: 'aaa bbb' });\\n\\n// You can use console to print some data\\nconsole.log(tiddlerData.fields.type);\\n// You can assign some data to a variable, it can be used in next context\\nconst tiddlerDataString = JSON.stringify(tiddlerData);\\n\\n// ↓ If you end the block with separator, you can write script execute in zx environment again\\n/** tw */\\nconsole.log(`\\\\n!! Hi!\\\\n`);\\nconsole.log(tiddlerDataString);\\n```\\n\\n!!! DB and execution\\n\\nStart from v0.8.0-prerelease11 of [TidGi](https://github.com/tiddly-gittly/TidGi-Desktop/releases), it has a [better-sqlite3](https://github.com/WiseLibs/better-sqlite3/blob/master/docs/api.md) instance at `$tw.utils.Sqlite`. Which is accessible for server side plugin (TidGi is a launcher for nodejs wiki, so can run server side plugins) or zx script.\\n\\n```js\\n// pure nodejs context\\nconsole.log(`## Hi!`);\\nlet aaa = 3;\\n\\n/** tw */\\n\\n// now in worker_thread with $tw wiki access\\n\\nlet filterExample = $tw.wiki.filterOperators.sum((callback) => {callback({}, String(aaa));callback({}, String(aaa))})\\nconsole.log(filterExample)\\n\\n// use Sqlite\\nconst db = $tw.utils.Sqlite\\nconst stmt = db.prepare('SELECT title, text FROM tiddlers');\\nconst result = stmt.pluck().all()\\nconsole.log(result)\\n```\"},\"$:/plugins/linonetwo/zx-script/developer\":{\"title\":\"$:/plugins/linonetwo/zx-script/developer\",\"type\":\"text/vnd.tiddlywiki\",\"text\":\"!! Developer guide\\n\\n!!! Icon\\n\\nIf you want to change the icon/text of the button, you need to change both [[ViewToolbarButton.tid|$:/plugins/linonetwo/zx-script/ViewToolbarButton]]'s caption field, and [[button.js|$:/plugins/linonetwo/zx-script/button.js]]'s `importButton.innerHTML = xxxx`.\\n\\nBecause we are using javascript to write the widget, it can't benefit from the caption field of tiddler that add tag [[$:/tags/ViewToolbar]].\\n\\nAnd so the caption add by javascript is shown not properly in view-toolbar, it will display both the icon and the text. So we need to use `.tc-tiddler-controls > button > .tc-button-zx-script-caption` to hide the text when it is in the view-toolbar.\\n\\n!!! List before\\n\\nWe use\\n\\n```tid\\nlist-before: $:/plugins/linonetwo/inverse-link-and-folder/infobar\\n```\\n\\nto make sure zx output is placed above the backlinks plugin.\\n\\n!!! Output\\n\\nWe place output of zx to a temporary tiddler, whose name start with \\\"$:/state/linonetwo/zx-script/output/\\\"\\n\\nAnd we get the name of this tiddler in wikitext using `[{!!title}addprefix[$:/state/linonetwo/zx-script/output/]`, so it can be transcluded with `{{{ }}}`\\n\"},\"$:/plugins/linonetwo/zx-script/readme\":{\"title\":\"$:/plugins/linonetwo/zx-script/readme\",\"created\":\"20210915220048497\",\"type\":\"text/vnd.tiddlywiki\",\"text\":\"!! Background\\n\\n[[google/zx|https://github.com/google/zx]] is a tool for writing better scripts, with Javascript.\\n\\nThis tiddlywiki plugin enables you to run any tiddler with zx.\\n\\n!! Basic Usage\\n\\n!!! Prerequisit\\n\\nThis plugin requires [TidGi](https://github.com/tiddly-gittly/TidGi-Desktop) Desktop App environment to function properly. It will send tiddler content to the `zx` inside TidGi, and prints the output.\\n\\n!!! Tiddler Type\\n\\nTiddler with title extension `*.js *.md *.mjs` can be execute without problem. Other tiddler witout extension (no `.xxx`) will be executed as `*.md` file, for example, tid file without extions will be executed as `*.md`, but it works without problem too, even you are writing wiki text instead of markdown.\\n\\nIf you add filetype `application/javascript` to your tiddler, it will be recognized as `*.mjs`.\\n\\n!!! Button\\n\\nA ViewToolbar button is added. You can click on it to execute the script inside your tiddler.\\n\\nAnd the zx output will be printed below your tiddler content.\\n\\n!!! Demo\\n\\n```js\\nconsole.log(`!! Hi!`);\\n```\\n\\nSee [[$:/plugins/linonetwo/zx-script/demo]] for demo of full tiddler execution.\\n\\n!! Wiki Scripting\\n\\n!!! Execute the code block on the $tw context\\n\\nYou can write some code that is surrounded with `/** tw */` separator. They will be recognized as js code and executed on the context that have access to the $tw api.\\n\\nGlobal variables you can use:\\n\\n* `$tw` try it in your [[developer tool|https://developer.mozilla.org/en-US/docs/Tools]] to play around!\\n* `_` [[lodash|https://lodash.com/docs/]]\\n\\nThis means you can fetch some data on the zx script, and write the results to the wiki, creating new tiddlers.\\n\\n!!! Access filter and macros\\n\\nFilter function's call example is\\n\\n```js\\n/** tw */\\nconst result = $tw.wiki.filterOperators.sum((callback) => {callback({}, '2');callback({}, '2')})\\nconsole.log(result)\\n```\\n\\n!! Developer Documentation\\n\\nSee [[$:/plugins/linonetwo/zx-script/developer]]\\n\"},\"$:/plugins/linonetwo/zx-script/style.css\":{\"title\":\"$:/plugins/linonetwo/zx-script/style.css\",\"text\":\".tc-tiddler-controls button .tc-button-zx-script-caption{display:none}.code-block-zx-script-execution-button{position:absolute;right:0;opacity:.3}.code-block-zx-script-execution-button:hover{opacity:.8}.code-block-zx-script-execution-button:active{opacity:1}article.zx-script-output{display:flex;flex-direction:column}\",\"creator\":\"LinOnetwo\",\"tags\":\"$:/tags/Stylesheet\",\"type\":\"text/css\"},\"$:/plugins/linonetwo/zx-script/zx-button-caption\":{\"title\":\"$:/plugins/linonetwo/zx-script/zx-button-caption\",\"type\":\"text/vnd.tiddlywiki\",\"text\":\"ZX Script\"},\"$:/plugins/linonetwo/zx-script/zx-icon\":{\"title\":\"$:/plugins/linonetwo/zx-script/zx-icon\",\"tags\":\"$:/tags/Image\",\"text\":\"<svg width=\\\"22pt\\\" height=\\\"22pt\\\" class=\\\"tc-image-zx-script tc-image-button\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\" xmlns:xlink=\\\"http://www.w3.org/1999/xlink\\\" version=\\\"1.1\\\" x=\\\"0px\\\" y=\\\"0px\\\" viewBox=\\\"0 0 100 90.25\\\"><path d=\\\"M93.103,83.904c0,0,1.708-1.634,3.242,0c1.535,1.634,0.322,2.203-0.223,2.426c-0.544,0.223-2.623,0.446-3.341-0.197 S92.635,84.248,93.103,83.904z\\\"></path><path d=\\\"M89.241,79.622c0,0,3.144-3.021,4.827-0.842c1.683,2.178,1.312,3.021-1.486,3.614c-2.796,0.595-3.861,1.263-5.37,0.595 c-1.511-0.669-2.005-2.13,0.495-2.724C89.241,79.622,89.241,79.622,89.241,79.622z\\\"></path><path d=\\\"M83.598,73.087c0.074-0.123,2.772-2.054,4.802-1.782c2.03,0.272,3.045,1.46,3.688,2.476s0.247,2.476-1.708,3.095 c-1.955,0.618-4.184,1.633-5.272,2.376c-1.089,0.742-2.302,0.989-3.317,0.42c-1.014-0.569-3.144-0.668-3.837-2.426 c-0.692-1.757,1.238-1.731,1.882-2.128S83.598,73.087,83.598,73.087z\\\"></path><path d=\\\"M74.191,66.429c0,0,4.554-3.218,7.476-3.664c2.921-0.445,4.652,0.99,5.891,2.625c1.237,1.633,2.438,4.059-1.603,5 c-4.041,0.94-5.328,2.029-6.17,2.524c-0.841,0.494-3.861,2.178-5.841,2.079c-1.98-0.099-4.803-1.089-5.842-1.881 c-1.04-0.792-2.872-1.733,0-3.268c2.871-1.535,4.059-2.277,4.059-2.277L74.191,66.429z\\\"></path><path d=\\\"M68.828,53.541c0,0,5.742-3.497,8.978-3.564c3.234-0.066,3.894,0.396,4.884,2.508c0.99,2.114,2.399,4.555,2.399,4.555 s0.636,2.708-2.796,3.631c-3.431,0.925-8.05,3.563-10.164,4.488c-2.113,0.925-6.206,4.818-11.024,4.753 c-4.817-0.065-8.978-1.518-10.297-3.894c-1.32-2.377,0.726-3.895,2.574-3.961c1.849-0.067,7.591-3.696,8.977-4.29 C63.746,57.173,68.828,53.541,68.828,53.541z\\\"></path><path d=\\\"M51.203,40.271l8.581-3.563c0,0,6.206-1.979,8.714-1.451c2.508,0.527,5.741,2.376,6.864,3.96s2.398,6.006,2.288,7.063 s-5.918,3.17-8.162,4.226c-2.245,1.056-13.004,6.007-14.588,7.128c-1.584,1.122-10.033,3.299-12.739,3.036 c-2.707-0.263-9.308-2.772-10.628-4.555s-3.367-3.763-0.99-4.95c2.376-1.188,6.138-2.573,8.118-3.828 C40.643,46.082,51.203,40.271,51.203,40.271z\\\"></path><path d=\\\"M28.894,11.229c0,0,14.158-0.198,16.535,0c2.376,0.198,13.367,0.495,16.139,2.277s5.941,5.644,7.128,8.614 c1.188,2.97,2.675,7.525,0,8.713c-2.673,1.188-14.06,5.743-17.425,7.624c-3.367,1.881-16.734,6.832-18.714,7.822 c-1.98,0.99-10.396,5.897-14.654,3.691c-4.258-2.205-7.525-11.91-7.921-14.384c0,0-2.475-5.743-2.673-15.644 c0,0-0.297-2.674-1.881-6.832c-1.584-4.159-3.07-6.436-3.07-6.436S0.675,0.833,4.041,2.516c3.366,1.683,2.818,2.161,6.237,3.564 c3.862,1.584,10,3.367,10.595,3.564C21.467,9.843,28.894,11.229,28.894,11.229z\\\"></path></svg>\"},\"$:/plugins/linonetwo/zx-script/button.js\":{\"title\":\"$:/plugins/linonetwo/zx-script/button.js\",\"type\":\"application/javascript\",\"module-type\":\"widget\",\"Modern.TiddlyDev#Origin\":\"button.ts\",\"text\":\"\\\"use strict\\\";var import_widget=require(\\\"$:/core/modules/widgets/widget.js\\\");function execute(e,i,s=\\\"text/vnd.tiddlywiki\\\",n,c){if(\\\"observables\\\"in window){let t=e.replace(/[/$:]/g,\\\"-\\\");if(!t.endsWith(\\\".mjs\\\")&&!t.endsWith(\\\".js\\\")&&!t.endsWith(\\\".md\\\"))switch(s){case\\\"text/vnd.tiddlywiki\\\":case\\\"text/plain\\\":case\\\"text/markdown\\\":case\\\"text/x-markdown\\\":case\\\"text/html\\\":t+=\\\".md\\\";break;case\\\"text/x-shellscript\\\":i=i.split(\\\"\\\\n\\\").map(t=>`await $\\\\`${t.trim()}\\\\`;`).join(\\\"\\\\n\\\"),t+=\\\".mjs\\\";break;case\\\"application/typescript\\\":t+=\\\".ts\\\";break;default:t+=\\\".mjs\\\"}n(),window.observables[\\\"native\\\"].executeZxScript$({fileContent:i,fileName:t}).subscribe(c)}}var ZXExecuteButtonWidget=class extends import_widget.widget{constructor(t,e){super(t,e),this.initialise(t,e)}render(t,e){this.parentDomNode=t,this.computeAttributes();var i=this.document.createElement(\\\"button\\\");$tw.utils.addClass(i,\\\"tc-btn-invisible\\\"),i.innerHTML=`${$tw.wiki.getTiddlerText(\\\"$:/plugins/linonetwo/zx-script/zx-icon\\\")}<span class=\\\"tc-btn-text tc-button-zx-script-caption\\\">${$tw.wiki.getTiddlerText(\\\"$:/plugins/linonetwo/zx-script/zx-button-caption\\\")}</span>`,i.onclick=this.onExecuteButtonClick.bind(this),i.title=\\\"ZX\\\",i.ariaLabel=i.title,t.insertBefore(i,e),this.domNodes.push(i)}async onExecuteButtonClick(){var t=this.getAttribute(\\\"title\\\");if(t){var e=this.getAttribute(\\\"type\\\")||\\\"text/vnd.tiddlywiki\\\",i=this.getAttribute(\\\"content\\\",\\\"\\\");const s=\\\"$:/state/linonetwo/zx-script/output/\\\"+t;execute(t,i,e,()=>{$tw.wiki.setText(s,\\\"text\\\",void 0,\\\"\\\")},t=>{var e=$tw.wiki.getTiddlerText(s);$tw.wiki.setText(s,\\\"text\\\",void 0,`${null!=e?e:\\\"\\\"}\\n`+(null!=t?t:\\\"\\\")),$tw.wiki.setText(s,\\\"type\\\",void 0,\\\"text/vnd.tiddlywiki\\\")})}}};exports[\\\"execute-zx-script\\\"]=ZXExecuteButtonWidget;\"},\"$:/plugins/linonetwo/zx-script/codeblock.js\":{\"title\":\"$:/plugins/linonetwo/zx-script/codeblock.js\",\"type\":\"application/javascript\",\"module-type\":\"widget\",\"Modern.TiddlyDev#Origin\":\"codeblock.ts\",\"text\":\"\\\"use strict\\\";function execute(t,s,i=\\\"text/vnd.tiddlywiki\\\",a,r){if(\\\"observables\\\"in window){let e=t.replace(/[/$:]/g,\\\"-\\\");if(!e.endsWith(\\\".mjs\\\")&&!e.endsWith(\\\".js\\\")&&!e.endsWith(\\\".md\\\"))switch(i){case\\\"text/vnd.tiddlywiki\\\":case\\\"text/plain\\\":case\\\"text/markdown\\\":case\\\"text/x-markdown\\\":case\\\"text/html\\\":e+=\\\".md\\\";break;case\\\"text/x-shellscript\\\":s=s.split(\\\"\\\\n\\\").map(e=>`await $\\\\`${e.trim()}\\\\`;`).join(\\\"\\\\n\\\"),e+=\\\".mjs\\\";break;case\\\"application/typescript\\\":e+=\\\".ts\\\";break;default:e+=\\\".mjs\\\"}a(),window.observables[\\\"native\\\"].executeZxScript$({fileContent:s,fileName:e}).subscribe(r)}}var BaseCodeBlockWidget=require(\\\"$:/core/modules/widgets/codeblock.js\\\").codeblock,ZX_SCRIPT_OUTPUT_ID=\\\"zx-script-output-id\\\";BaseCodeBlockWidget.prototype.render=function(e,t){this.parentDomNode=e,this.computeAttributes(),this.execute();var s=this.document.createElement(\\\"code\\\"),i=this.document.createElement(\\\"pre\\\");s.appendChild(this.document.createTextNode(this.getAttribute(\\\"code\\\"))),i.appendChild(s);const a=this.getAttribute(\\\"language\\\"),d=this.document.createElement(\\\"article\\\");d.style.display=\\\"none\\\",$tw.utils.addClass(d,\\\"zx-script-output\\\"),[\\\"md\\\",\\\"js\\\",\\\"javascript\\\",\\\"ts\\\",\\\"typescript\\\",\\\"bash\\\",\\\"shell\\\",\\\"sh\\\",\\\"zsh\\\"].includes(a)&&((s=this.document.createElement(\\\"button\\\")).innerText=\\\"ZX\\\",s.className=\\\"code-block-zx-script-execution-button\\\",s.addEventListener(\\\"click\\\",()=>{var e=\\\"tmp.\\\"+a,t=this.getAttribute(\\\"code\\\");let s=\\\"text/vnd.tiddlywiki\\\";switch(a){case\\\"markdown\\\":case\\\"md\\\":s=\\\"text/x-markdown\\\";break;case\\\"js\\\":case\\\"javascript\\\":s=\\\"application/javascript\\\";break;case\\\"ts\\\":case\\\"typescript\\\":s=\\\"application/typescript\\\";break;case\\\"bash\\\":case\\\"zsh\\\":case\\\"shell\\\":case\\\"sh\\\":s=\\\"text/x-shellscript\\\";break;default:return void(d.innerText=\\\"ZX don't execute \\\"+a)}const r=Math.random().toString(36).slice(2);let c=\\\"\\\";execute(e,t,s,()=>{d.innerText=\\\"\\\",d.style.display=\\\"flex\\\",$tw.utils.addClass(d,\\\"hljs\\\"),$tw.utils.addClass(d,\\\"js\\\"),$tw.utils.addClass(d,\\\"javascript\\\"),c=\\\"\\\"},e=>{var t=\\\"\\\"+c+(c?\\\"\\\\n\\\\n\\\":\\\"\\\")+(null!=e?e:\\\"\\\");c=t;try{this.children=this.children.filter(e=>e.getVariable(ZX_SCRIPT_OUTPUT_ID,{allowSelfAssigned:!0})!==r),d.innerText=\\\"\\\";var s=$tw.wiki.parseText(\\\"text/vnd.tiddlywiki\\\",t).tree,i=this.makeChildWidget({type:\\\"tiddler\\\",children:s});i.setVariable(ZX_SCRIPT_OUTPUT_ID,r),i.render(d,null),this.children.push(i)}catch(a){console.error(a),d.innerText=t}})}),e.insertBefore(s,t)),e.insertBefore(i,t),e.insertBefore(d,t),this.domNodes.push(i),this.domNodes.push(d),this.postRender&&this.postRender()};\"}}}",
        "Modern.TiddlyDev#SHA256-Hashed": "fe21225458c587c899d93b46c60c62a40d83b1cdb769f7aa225465260dd047a5"
    }
]