<script type="application/javascript">
  // we won't do copy on select on text editor, otherwise you can't select and override text in the editor or text input
  function checkIfElementIsEditor(element) {
    if (!element || !element.nodeName) return false;
    const isEditableElement = ['INPUT', 'TEXTAREA', 'BUTTON'].includes(element.nodeName);
    if (!isEditableElement) {
      if (!element.className || !element.className.toLowerCase) return false;
    }
    const isTextEditor = element.className.toLowerCase().includes('codemirror');
    const isSlateEditor = element.dataset.slateEditor || element.dataset.slateNode || element.dataset.slateLeaf || element.dataset.slateString;

    return isEditableElement || isTextEditor || isSlateEditor;
  }
  // if we start selection on editor, we prevent the following execution of this script
  let copyOnSelectPreventCopy = false;
  /** mousedown and wait for 1s to copy */
  let copyTimeoutDone = false;
  /** 1s */
  const copyTimeout = 1;
  document.addEventListener('mousedown', function onMouseDown() {
    const elementsUnderMouse = document.querySelectorAll(':hover');

    if (!elementsUnderMouse || Array.from(elementsUnderMouse).some(checkIfElementIsEditor)) {
      copyOnSelectPreventCopy = true;
    } else {
      copyOnSelectPreventNextCopy = false;
      copyTimeoutDone = false;
      setTimeout(() => {
        copyTimeoutDone = true;
      }, copyTimeout * 1000);
    }
  });
  // Copy on select, copy document selection when mouse button is up
  document.addEventListener('mouseup', function onMouseUp() {
    /** NodeList */
    const elementsUnderMouse = document.querySelectorAll(':hover');

    const copyPrevented = !copyTimeoutDone || copyOnSelectPreventCopy || !elementsUnderMouse || Array.from(elementsUnderMouse).some(checkIfElementIsEditor);
    if (copyPrevented) {
      copyOnSelectPreventNextCopy = false;
      copyTimeoutDone = false;
      return;
    }
    document.execCommand('copy');
    let copiedText = Array.from(elementsUnderMouse)
      .map((element) => element.textContent)
      .join('');
    const truncateLength = 30;
    if (copiedText.length > truncateLength) {
      copiedText = `${copiedText.substring(0, 30)} ...`;
    }
    $tw.rootWidget.dispatchEvent('tm-notify', { param: `Copy: ${copiedText}` });
  });
</script>
